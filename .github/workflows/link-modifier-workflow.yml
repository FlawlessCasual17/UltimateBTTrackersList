name: Modify README Links

on:

  push:
    # Trigger on changes to README.md found in any directory
    paths: ['**/README.md']

  workflow_dispatch:  # Allow manual triggering

jobs:
  modify-links:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.TOKEN }}

    steps:
    - name: 'Checkout Repository'
      uses: 'actions/checkout@v4'
      with:
          repository: ${{ github.repository }}
          token: ${{ secrets.TOKEN }}

    - name: 'Install fd'
      run: |
        sudo apt-get update && sudo apt-get install -y fd-find
        # Check if fd already exists, and if it does not, then create it
        if ! command -v fd &> /dev/null; then
          sudo ln -v -s $(which fdfind) /bin/fd
        fi

    - name: 'Modify links in README.md'
      shell: bash
      run: |
        export PATH=$PATH:~/.local/bin
        echo "\$PATH: $PATH"
        cp -v ./scripts/create-index-md-files .
        chmod +x ./create-index-md-files
        exec ./create-index-md-files

    - name: 'Commit changes'
      shell: bash
      run: |
        git config --local user.name 'github-actions[bot]'
        git config --local user.email '41898282+github-actions[bot]@users.noreply.github.com'
        git add -A
        current_time=$(date +'%Y-%m-%d %H:%M:%S')
        git commit -a -m "Created/Updated \`index.md\` files at $current_time"

    - name: 'Push changes'
      uses: 'ad-m/github-push-action@v0.8.0'
      with:
        github_token: ${{ secrets.TOKEN }}
        branch: ${{ github.ref }}

    - name: 'Uninstall fd'
      shell: bash
      run: |
        sudo rm $(which fd)
        sudo apt-get remove -y --purge fd-find
